<?xml version="1.0"?>
<manageRTools category="Spatial">
    <RTool name="Load OGR data" subcategory= "Import/Export">
        <Query><![CDATA[|2| <- local({
require(rgdal)
readOGR('|1|', '|2|', verbose = TRUE, p4s=NULL, drop_unsupported_fields=FALSE,
input_field_name_encoding=NULL, pointDropZ=FALSE, dropNULLGeometries=TRUE)})]]></Query>
        <Help name="readOGR"/>
        <Widget id="1" label="Input data source" type="LineEdit" default="/path/to/layer.shp"/>
        <Widget id="2" label="Layer name" type="LineEdit" default="layer"/>
    </RTool>
    <RTool name="Write OGR data" subcategory= "Import/Export">
        <Query><![CDATA[local({
require(rgdal)
writeOGR(|1|, '|2|', |3|, |4|, dataset_options=NULL, layer_options=NULL, verbose=TRUE)})]]></Query>
        <Help name="writeOGR"/>
        <Widget id="1" label="Input layer:" type="VariableComboBox"/>
        <Widget id="2" label="Output path:" type="LineEdit" default="/output/path/layer.shp"/>
        <Widget id="3" label="Output layer name:" type="LineEdit" default="layer"/>
        <Widget id="4" label="Driver name:" type="ComboBox" default="ESRI Shapefile;GML;KML;MapInfo File;CSV;PostgreSQL;SQLite;ODBC;MySQL;GPX;GMT;GeoJSON"/>
    </RTool>
    <RTool name="Load GDAL data" subcategory= "Import/Export">
        <Query><![CDATA[|2| <- local({
require(rgdal)
readGDAL('|1|')})]]></Query>
        <Help name="readGDAL"/>
        <Widget id="1" label="Input data source" type="LineEdit" default="/path/to/layer.tiff"/>
        <Widget id="2" label="Layer name" type="LineEdit" default="layer"/>
    </RTool>
    <RTool name="Write GDAL data" subcategory= "Import/Export">
        <Query><![CDATA[local({
require(rgdal)
writeGDAL(|1|, '|2|', drivername='|3|', type='Float32', mvFlag=|4|, copy_drivername='|3|')
})]]></Query>
        <Help name="writeGDAL"/>
        <Widget id="1" label="Input layer:" type="VariableComboBox"/>
        <Widget id="2" label="Input data source:" type="LineEdit" default="/path/to/layer.tiff"/>
        <Widget id="3" label="Driver name:" type="ComboBox" default="GTiff;VRT;PNG;JPEG;EHdr;ENVI"/>
        <Widget id="4" label="Missing value flag:" type="LineEdit" default="NA"/>
    </RTool>
    <RTool name="Voronoi polygons" subcategory= "Geometry">
        <Query><![CDATA[|2| <- local({
require(deldir)
rds <- |1|@coords
z <- deldir(crds[,1], crds[,2])
w <- tile.list(z)
polys <- vector(mode='list', length=length(w))
require(sp)
for (i in seq(along=polys)) {
    pcrds <- cbind(w[[i]]$x, w[[i]]$y)
    pcrds <- rbind(pcrds, pcrds[1,])
    polys[[i]] <- Polygons(list(Polygon(pcrds)), ID=as.character(i))
}
SP <- SpatialPolygons(polys)
areas <- sapply(slot(SP, 'polygons'), function(x) sapply(slot(x,'Polygons'), slot, 'area'))
SpatialPolygonsDataFrame(SP, data=data.frame(x=crds[,1], y=crds[,2], row.names=sapply(slot(SP, 'polygons'), function(x) slot(x, 'ID')), area=areas))
})]]></Query>
        <Help name="deldir"/>
        <Widget id="1" label="Point layer:" type="VariableComboBox"/>
        <Widget id="2" label="Output layer:" type="LineEdit" default="voronoi" notnull="true"/>
    </RTool>
    <RTool name="Polygon centroids"  subcategory= "Geometry">
        <Query><![CDATA[|2| <- local({
proj <- proj4string(|1|)
coords <- coordinates(|1|)
attrs <- |1|@data
SpatialPointsDataFrame(coords=coords, data=attrs, proj4string=CRS(proj))
})]]></Query>
        <Help name="coordinates"/>
        <Widget id="1" label="Polygon layer:" type="VariableComboBox"/>
        <Widget id="2" label="Output layer:" type="LineEdit" default="centroids"/>
    </RTool>
<RTool name="Create spatial weights" category= "Spatial operations" query=
"require(spdep)
|7| <- local({
    input <- |1|
    type <- '|2|'
    value <- |3|
    style <- '|6|'
    if ('|4|'=='binary') decay <- 1
    else decay <- |5|
    if (type=='contiguity') {
        weights <- poly2nb(pl=input, snap=0.0005, queen=T) #Better parameter for snap?
        if (value >= 2) {
            nblags <- nblag(neighbours=weights, maxlag=value)
            weights <- nblag.cumul(nblags=nblags)
         }
    } else {
        ids <- seq(1,dim(input@data)[1])
        proj4 <- proj4string(input)
        coords <- coordinates(obj=input)
        points <- SpatialPoints(coords=coords, proj4string=CRS(proj4))
        if (type=='distance') {
            dist <- dnearneigh(x=points, d1=0, d2=value, row.names=ids)
        } else { # 'knearest'
            knear <- knearneigh(x=points, k=value)
            dist <- knn2nb(knn=knear, row.names=ids, sym=FALSE)
        }
        dlist <- nbdists(nb=dist, coords=points)
        decayfun <- function(x) 1/(x^decay)
        idlist <- lapply(X=dlist, FUN=decayfun)
        weights <- nb2listw(neighbours=dist, glist=idlist, style=style, zero.policy=T)
    }
})">
<Widget id= label="Input layer:" type="spComboBox" default=
"SpatialPointsDataFrame;SpatialLinesDataFrame;SpatialPolygonsDataFrame" notnull="true"/>
<Widget id= label="Spatial neighbourhood type:" type="comboBox" default="distance;knearest;contiguity" notnull="true"/>
<Widget id= label="Distance or K neighbours or K lags:" type="doubleSpinBox" default="1.00" notnull="true"/>
<Widget id= label="Weighting scheme:" type="comboBox" default="binary;inverse.distance" notnull="true"/>
<Widget id= label="Distance decay:" type="doubleSpinBox" default="1.00" notnull="true"/>
<Widget id= label="Weighting style:" type="comboBox" default="W;B;C;U;S" notnull="true"/>
<Widget id= label="Output name:" type="lineEdit" default="weights" notnull="true"/>
<Widget id= label="help" type="helpString" default="topic:nb2listw" notnull="true"/>
</RTool>
<RTool name="Moran scatterplot" category= "Plotting" query=
"require(spdep)
local({
moran.plot(|1|, |2|, zero.policy=FALSE, spChk=FALSE, quiet=ifelse(|3|,FALSE,TRUE),
main='|4|', sub='|5|', xlab='|6|', ylab=paste('Spatially lagged','|6|'), 
bty='|7|', labels=|3|)
})">
<Widget id= label="Input layer:" type="spComboBox" default="numeric;integer" notnull="true"/>
<Widget id= label="Weights object (listw):" type="spComboBox" default="listw" notnull="true"/>
<Widget id= label="Display influential variables:" type="comboBox" default="TRUE;FALSE" notnull="true"/>
<Widget id= label="Main title:" type="lineEdit" default="Moran scatterplot" notnull="false"/>
<Widget id= label="Sub title:" type="lineEdit" default="" notnull="false"/>
<Widget id= label="X label:" type="lineEdit" default="X Axis" notnull="false"/>
<Widget id= label="Bounding box:" type="comboBox" default=
"outline;l-shape;7-shape;c-shape;u-shape;]-shape;none" notnull="true"/>
<Widget id= label="help" type="helpString" default="topic:moran.plot" notnull="true"/>
</RTool>
<RTool name="Moran's I" category= "Spatial statistics" query=
"require(spdep)
local({
moran.test(|1|, |2|, randomisation=ifelse('|3|'=='normality',FALSE,TRUE), alternative='|4|', rank=|5|)

})">
<Widget id= label="Input layer:" type="spComboBox" default="numeric;integer" notnull="true"/>
<Widget id= label="Weights object (listw):" type="spComboBox" default="listw" notnull="true"/>
<Widget id= label="Variance assumption:" type="comboBox" default="randomisation;normality" notnull="true"/>
<Widget id= label="Alternative hypothesis:" type="comboBox" default="greater;less;two.sided" notnull="true"/>
<Widget id= label="Ranked data:" type="comboBox" default="FALSE;TRUE" notnull="true"/>
<Widget id= label="help" type="helpString" default="topic:moran.test" notnull="true"/>
</RTool>
<RTool name="Moran's I permutation test" category= "Spatial statistics" query=
"require(spdep)
|6| <- moran.mc(|1|, |2|, nsim=|3|, alternative='|4|')
if (|5|) plot(|6|)
if (|7|) |6|">
<Widget id= label="Input layer:" type="spComboBox" default="numeric;integer" notnull="true"/>
<Widget id= label="Weights object (listw):" type="spComboBox" default="listw" notnull="true"/>
<Widget id= label="Number of simulations:" type="doubleSpinBox" default="99" notnull="true"/>
<Widget id= label="Alternative hypothesis:" type="comboBox" default="greater;less;two.sided" notnull="true"/>
<Widget id= label="Display density plot:" type="comboBox" default="FALSE;TRUE" notnull="true"/>
<Widget id= label="Output name:" type="lineEdit" default="perm.moran" notnull="true"/>
<Widget id= label="Print results:" type="comboBox" default="TRUE;FALSE" notnull="true"/>
<Widget id= label="help" type="helpString" default="topic:moran.mc" notnull="true"/>
</RTool>
<RTool name="Geary's c" category= "Spatial statistics" query=
"require(spdep)
local({
geary.test(|1|, |2|, randomisation=ifelse('|3|'=='normality',FALSE,TRUE), alternative='|4|')

})">
<Widget id= label="Input layer:" type="spComboBox" default="numeric;integer" notnull="true"/>
<Widget id= label="Weights object (listw):" type="spComboBox" default="listw" notnull="true"/>
<Widget id= label="Variance assumption:" type="comboBox" default="randomisation;normality" notnull="true"/>
<Widget id= label="Alternative hypothesis:" type="comboBox" default="greater;less;two.sided" notnull="true"/>
<Widget id= label="help" type="helpString" default="topic:geary.test" notnull="true"/>
</RTool>
<RTool name="Geary's c permutation test" category= "Spatial statistics" query=
"require(spdep)
|6| <- geary.mc(|1|, |2|, nsim=|3|, alternative='|4|')
if (|5|) plot(|6|)
if (|7|) |6|">
<Widget id= label="Input layer:" type="spComboBox" default="numeric;integer" notnull="true"/>
<Widget id= label="Weights object (listw):" type="spComboBox" default="listw" notnull="true"/>
<Widget id= label="Number of simulations:" type="doubleSpinBox" default="99" notnull="true"/>
<Widget id= label="Alternative hypothesis:" type="comboBox" default="less;greater" notnull="true"/>
<Widget id= label="Display density plot:" type="comboBox" default="FALSE;TRUE" notnull="true"/>
<Widget id= label="Output name:" type="lineEdit" default="perm.gery" notnull="true"/>
<Widget id= label="Print results:" type="comboBox" default="TRUE;FALSE" notnull="true"/>
<Widget id= label="help" type="helpString" default="topic:geary.mc" notnull="true"/>
</RTool>
<RTool name="Local Gi statistics" category= "Spatial statistics" query=
"require(spdep)
|4| <- local({
if (|3|) weights <- nb2listw(include.self(|2|$neighbours),
style=|2|$style,glist=lapply(|2|$weights, function(x) c(1,x)))
else weights <- weights
localG(|1|, weights)
})
if (|5|) |4|">
<Widget id= label="Input layer:" type="spComboBox" default="numeric;integer" notnull="true"/>
<Widget id= label="Weights object (listw):" type="spComboBox" default="listw" notnull="true"/>
<Widget id= label="Gi* Statistic:" type="comboBox" default="TRUE;FALSE" notnull="true"/>
<Widget id= label="Output name:" type="lineEdit" default="local.Gi" notnull="true"/>
<Widget id= label="Print results:" type="comboBox" default="FALSE;TRUE" notnull="true"/>
<Widget id= label="help" type="helpString" default="topic:localG" notnull="true"/>
</RTool>
<RTool name="Local Moran's Ii statistic" category= "Spatial statistics" query=
"require(spdep)
|5| <- local({
localmoran(|1|, |2|, alternative='|3|', p.adjust.method='|4|')
})
if (|6|) |5|">
<Widget id= label="Input layer:" type="spComboBox" default="numeric;integer" notnull="true"/>
<Widget id= label="Weights object (listw):" type="spComboBox" default="listw" notnull="true"/>
<Widget id= label="Alternative hypothesis:" type="comboBox" default="greater;less;two.sided" notnull="true"/>
<Widget id= label="P-value adjustment:" type="comboBox" default="none;bonferroni;holm;hochberg;hommel;fdr" notnull="true"/>
<Widget id= label="Output name:" type="lineEdit" default="local.moran" notnull="true"/>
<Widget id= label="Print results:" type="comboBox" default="FALSE;TRUE" notnull="true"/>
<Widget id= label="help" type="helpString" default="topic:localmoran" notnull="true"/>
</RTool>
</manageRTools>
