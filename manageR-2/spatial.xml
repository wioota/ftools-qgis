<?xml version="1.0"?>
<manageRTools category="Spatial">
    <RTool name="Load OGR data" subcategory= "Import/Export">
        <Query><![CDATA[require(rgdal)
|2| <- local({
    readOGR('|1|', '|2|', verbose = TRUE, p4s=NULL, drop_unsupported_fields=FALSE,
    input_field_name_encoding=NULL, pointDropZ=FALSE, dropNULLGeometries=TRUE)
})]]></Query>
        <Help name="readOGR"/>
        <Dialog>
            <Widget id="1" label="Input data source" type="FileOpenLineEdit"/>
            <Widget id="2" label="Layer name" type="LineEdit" default="layer"/>
        </Dialog>
    </RTool>
    <RTool name="Write OGR data" subcategory= "Import/Export">
        <Query><![CDATA[require(rgdal)
local({
    writeOGR(|1|, '|2|', |3|, |4|, dataset_options=NULL, layer_options=NULL, verbose=TRUE)
})]]></Query>
        <Help name="writeOGR"/>
        <Dialog>
            <Widget id="1" label="Input layer:" type="VariableComboBox"/>
            <Widget id="2" label="Output path:" type="FileSaveLineEdit"/>
            <Widget id="3" label="Output layer name:" type="LineEdit" default="layer"/>
            <Widget id="4" label="Driver name:" type="ComboBox" default="ESRI Shapefile;GML;KML;MapInfo File;CSV;PostgreSQL;SQLite;ODBC;MySQL;GPX;GMT;GeoJSON"/>
        </Dialog>
    </RTool>
    <RTool name="Load GDAL data" subcategory= "Import/Export">
        <Query><![CDATA[require(rgdal)
|2| <- local({
    readGDAL('|1|')
})]]></Query>
        <Help name="readGDAL"/>
        <Dialog>
            <Widget id="1" label="Input data source:" type="FileOpenLineEdit"/>
            <Widget id="2" label="Layer name" type="LineEdit" default="layer"/>
        </Dialog>
    </RTool>
    <RTool name="Write GDAL data" subcategory= "Import/Export">
        <Query><![CDATA[require(rgdal)
local({
    writeGDAL(|1|, '|2|', drivername='|3|', type='Float32', mvFlag=|4|, copy_drivername='|3|')
})]]></Query>
        <Help name="writeGDAL"/>
        <Dialog>
            <Widget id="1" label="Input layer:" type="VariableComboBox"/>
            <Widget id="2" label="Output file name:" type="FileSaveLineEdit"/>
            <Widget id="3" label="Driver name:" type="ComboBox" default="GTiff;VRT;PNG;JPEG;EHdr;ENVI"/>
            <Widget id="4" label="Missing value flag:" type="LineEdit" default="NA"/>
        </Dialog>
    </RTool>
    <RTool name="Voronoi polygons" subcategory= "Geometry">
        <Query><![CDATA[require(deldir)
|2| <- local({
    rds <- |1|@coords
    z <- deldir(crds[,1], crds[,2])
    w <- tile.list(z)
    polys <- vector(mode='list', length=length(w))
    require(sp)
    for (i in seq(along=polys)) {
        pcrds <- cbind(w[[i]]$x, w[[i]]$y)
        pcrds <- rbind(pcrds, pcrds[1,])
        polys[[i]] <- Polygons(list(Polygon(pcrds)), ID=as.character(i))
    }
    SP <- SpatialPolygons(polys)
    areas <- sapply(slot(SP, 'polygons'), function(x) sapply(slot(x,'Polygons'), slot, 'area'))
    SpatialPolygonsDataFrame(SP, data=data.frame(x=crds[,1], y=crds[,2], row.names=sapply(slot(SP, 'polygons'), function(x) slot(x, 'ID')), area=areas))
})]]></Query>
        <Help name="deldir"/>
        <Dialog>
            <Widget id="1" label="Point layer:" type="VariableComboBox"/>
            <Widget id="2" label="Output layer:" type="LineEdit" default="voronoi"/>
        </Dialog>
    </RTool>
    <RTool name="Polygon centroids"  subcategory= "Geometry">
        <Query><![CDATA[|2| <- local({
    proj <- proj4string(|1|)
    coords <- coordinates(|1|)
    attrs <- |1|@data
    SpatialPointsDataFrame(coords=coords, data=attrs, proj4string=CRS(proj))
})]]></Query>
        <Help name="coordinates"/>
        <Dialog>
            <Widget id="1" label="Polygon layer:" type="VariableComboBox"/>
            <Widget id="2" label="Output layer:" type="LineEdit" default="centroids"/>
        </Dialog>
    </RTool>
    <RTool name="Create spatial weights">
        <Query><![CDATA[require(spdep)
|7| <- local({
    input <- |1|
    type <- '|2|'
    value <- |3|
    style <- '|6|'
    if ('|4|'=='binary') decay <- 1
    else decay <- |5| # Adjust distance decay parameter
    if (type=='contiguity') {
        weights <- poly2nb(pl=input, snap=0.0005, queen=T) # Better parameter for snap?
        if (value >= 2) {
            nblags <- nblag(neighbours=weights, maxlag=value)
            weights <- nblag.cumul(nblags=nblags)
         }
    } else {
        ids <- seq(1,dim(input@data)[1])
        proj4 <- proj4string(input)
        coords <- coordinates(obj=input)
        points <- SpatialPoints(coords=coords, proj4string=CRS(proj4))
        if (type=='distance') {
            dist <- dnearneigh(x=points, d1=0, d2=value, row.names=ids)
        } else { # 'knearest'
            knear <- knearneigh(x=points, k=value)
            dist <- knn2nb(knn=knear, row.names=ids, sym=FALSE)
        }
        dlist <- nbdists(nb=dist, coords=points)
        decayfun <- function(x) 1/(x^decay)
        idlist <- lapply(X=dlist, FUN=decayfun)
        weights <- nb2listw(neighbours=dist, glist=idlist, style=style, zero.policy=T)
    }
})]]></Query>
        <Help name="nb2listw"/>
        <Dialog>
            <Widget id="1" label="Input layer:" type="VariableComboBox" default="Spatial.*DataFrame"/>
            <Widget id="7" label="Output name:" type="LineEdit" default="weights"/>
            <Group name="Spatial neighbourhood">
                <Widget id="2" label="Spatial neighbourhood type:" type="ComboBox" default="distance;knearest;contiguity" alternate=
                    "Distance based;K Nearest neighbours;Polygon contiguity"/>
                <Widget id="3" label="Distance or K neighbours or K lags:" type="DoubleSpinBox" default="1.00"/>
                <Widget id="5" label="Distance decay:" type="DoubleSpinBox" default="1.00"/>
            </Group>
            <Group name="Adjust weights">
                <Widget id="4" label="Weighting scheme:" type="ComboBox" default="binary;inverse.distance" alternate=
                    "Binary; Inverse distance"/>
                <Widget id="6" label="Weighting style:" type="ComboBox" default="W;B;C;U;S" alternate=
                    "Row standardised;Binary coding;Globally standardised;(Scaled) globally standised;Variance-stabilising"/>
            </Group>
        </Dialog>
    </RTool>
    <RTool name="Moran scatterplot" subcategory= "Statistics">
    <Query><![CDATA[require(spdep)
local({
    moran.plot(|1|, |2|, zero.policy=FALSE, spChk=FALSE, 
        quiet=|3|, labels=|3|, |4|)
})]]></Query>
        <Help name="moran.plot"/>
        <Dialog>
            <Widget id="1" label="Input layer:" type="VariableComboBox"/>
            <Widget id="2" label="Weights object (listw):" type="VariableComboBox"/>
            <Widget id="3" label="Display influential variables" type="CheckBox" default="true"/>
            <Widget id="4" type="PlotOptionsBox" default="titles;box"/>
        </Dialog>
    </RTool>

<RTool name="Moran's I" subcategory= "Statistics">
    <Query><![CDATA[require(spdep)
local({
    moran.test(|1|, |2|, randomisation=ifelse('|3|'=='normality',FALSE,TRUE), 
        alternative='|4|', rank=|5|)
})]]></Query>
    <Help name="moran.test"/>
    <Dialog>
        <Widget id="1" label="Input layer:" type="VariableComboBox"/>
        <Widget id="2" label="Weights object (listw):" type="VariableComboBox"/>
        <Columns>
            <Widget id="3" label="Variance assumption" type="RadioGroupBox" default="Randomisation;Normality"/>
            <Widget id="4" label="Alternative hypothesis" type="RadioGroupBox" default="greater;less;two.sided"/>
        </Columns>
        <Widget id="5" label="Treat as ranked data" type="CheckBox" default="false"/>
    </Dialog>
</RTool>
<!--<RTool name="Moran's I permutation test" category= "Spatial statistics" query=-->
<!--"require(spdep)-->
<!--|6| <- moran.mc(|1|, |2|, nsim=|3|, alternative='|4|')-->
<!--if (|5|) plot(|6|)-->
<!--if (|7|) |6|">-->
<!--<Widget id= label="Input layer:" type="spComboBox" default="numeric;integer" notnull="true"/>-->
<!--<Widget id= label="Weights object (listw):" type="spComboBox" default="listw" notnull="true"/>-->
<!--<Widget id= label="Number of simulations:" type="doubleSpinBox" default="99" notnull="true"/>-->
<!--<Widget id= label="Alternative hypothesis:" type="comboBox" default="greater;less;two.sided" notnull="true"/>-->
<!--<Widget id= label="Display density plot:" type="comboBox" default="FALSE;TRUE" notnull="true"/>-->
<!--<Widget id= label="Output name:" type="lineEdit" default="perm.moran" notnull="true"/>-->
<!--<Widget id= label="Print results:" type="comboBox" default="TRUE;FALSE" notnull="true"/>-->
<!--<Widget id= label="help" type="helpString" default="topic:moran.mc" notnull="true"/>-->
<!--</RTool>-->
<!--<RTool name="Geary's c" category= "Spatial statistics" query=-->
<!--"require(spdep)-->
<!--local({-->
<!--geary.test(|1|, |2|, randomisation=ifelse('|3|'=='normality',FALSE,TRUE), alternative='|4|')-->

<!--})">-->
<!--<Widget id= label="Input layer:" type="spComboBox" default="numeric;integer" notnull="true"/>-->
<!--<Widget id= label="Weights object (listw):" type="spComboBox" default="listw" notnull="true"/>-->
<!--<Widget id= label="Variance assumption:" type="comboBox" default="randomisation;normality" notnull="true"/>-->
<!--<Widget id= label="Alternative hypothesis:" type="comboBox" default="greater;less;two.sided" notnull="true"/>-->
<!--<Widget id= label="help" type="helpString" default="topic:geary.test" notnull="true"/>-->
<!--</RTool>-->
<!--<RTool name="Geary's c permutation test" category= "Spatial statistics" query=-->
<!--"require(spdep)-->
<!--|6| <- geary.mc(|1|, |2|, nsim=|3|, alternative='|4|')-->
<!--if (|5|) plot(|6|)-->
<!--if (|7|) |6|">-->
<!--<Widget id= label="Input layer:" type="spComboBox" default="numeric;integer" notnull="true"/>-->
<!--<Widget id= label="Weights object (listw):" type="spComboBox" default="listw" notnull="true"/>-->
<!--<Widget id= label="Number of simulations:" type="doubleSpinBox" default="99" notnull="true"/>-->
<!--<Widget id= label="Alternative hypothesis:" type="comboBox" default="less;greater" notnull="true"/>-->
<!--<Widget id= label="Display density plot:" type="comboBox" default="FALSE;TRUE" notnull="true"/>-->
<!--<Widget id= label="Output name:" type="lineEdit" default="perm.gery" notnull="true"/>-->
<!--<Widget id= label="Print results:" type="comboBox" default="TRUE;FALSE" notnull="true"/>-->
<!--<Widget id= label="help" type="helpString" default="topic:geary.mc" notnull="true"/>-->
<!--</RTool>-->
<!--<RTool name="Local Gi statistics" category= "Spatial statistics" query=-->
<!--"require(spdep)-->
<!--|4| <- local({-->
<!--if (|3|) weights <- nb2listw(include.self(|2|$neighbours),-->
<!--style=|2|$style,glist=lapply(|2|$weights, function(x) c(1,x)))-->
<!--else weights <- weights-->
<!--localG(|1|, weights)-->
<!--})-->
<!--if (|5|) |4|">-->
<!--<Widget id= label="Input layer:" type="spComboBox" default="numeric;integer" notnull="true"/>-->
<!--<Widget id= label="Weights object (listw):" type="spComboBox" default="listw" notnull="true"/>-->
<!--<Widget id= label="Gi* Statistic:" type="comboBox" default="TRUE;FALSE" notnull="true"/>-->
<!--<Widget id= label="Output name:" type="lineEdit" default="local.Gi" notnull="true"/>-->
<!--<Widget id= label="Print results:" type="comboBox" default="FALSE;TRUE" notnull="true"/>-->
<!--<Widget id= label="help" type="helpString" default="topic:localG" notnull="true"/>-->
<!--</RTool>-->
<!--<RTool name="Local Moran's Ii statistic" category= "Spatial statistics" query=-->
<!--"require(spdep)-->
<!--|5| <- local({-->
<!--localmoran(|1|, |2|, alternative='|3|', p.adjust.method='|4|')-->
<!--})-->
<!--if (|6|) |5|">-->
<!--<Widget id= label="Input layer:" type="spComboBox" default="numeric;integer" notnull="true"/>-->
<!--<Widget id= label="Weights object (listw):" type="spComboBox" default="listw" notnull="true"/>-->
<!--<Widget id= label="Alternative hypothesis:" type="comboBox" default="greater;less;two.sided" notnull="true"/>-->
<!--<Widget id= label="P-value adjustment:" type="comboBox" default="none;bonferroni;holm;hochberg;hommel;fdr" notnull="true"/>-->
<!--<Widget id= label="Output name:" type="lineEdit" default="local.moran" notnull="true"/>-->
<!--<Widget id= label="Print results:" type="comboBox" default="FALSE;TRUE" notnull="true"/>-->
<!--<Widget id= label="help" type="helpString" default="topic:localmoran" notnull="true"/>-->
<!--</RTool>-->
</manageRTools>
